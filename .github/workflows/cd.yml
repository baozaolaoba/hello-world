name: "打包和部署"

on:
  push:
    tags:
      - v*

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: "克隆代码"
        uses: actions/checkout@v3

      - name: "登录github容器注册中心"
        uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "为image打包准备元信息"
        id: meta
        uses: docker/metadata-action@98669ae865ea3cffbcbaa878cf57c20bbf1c6c38
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: "构建image并推送至注册中心"
        uses: docker/build-push-action@ad44023a93711e3deb337508980b4b5e9bcdc5dc
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: "k8s设置context"
        uses: Azure/k8s-set-context@v3.0
        with:
          # Acceptable values: generic or arc
          cluster-type: generic
          # Acceptable values: kubeconfig or service-account or service-principal
          method: kubeconfig
          # Contents of kubeconfig file
          kubeconfig: ${{ secrets.KUBECONFIG }}
          
      - name: "创建k8s密钥"
        uses: Azure/k8s-create-secret@v4.0
        with:
          # Name of the secret. You can use this secret name in the Kubernetes YAML configuration file.
          secret-name: docker-login
          # Container Registry URL
          container-registry-url: ${{ env.REGISTRY }}
          # Container Registry user name
          container-registry-username: ${{ github.actor }}
          # Container Registry password
          container-registry-password: ${{ secrets.GITHUB_TOKEN }}

      - name: "替换deploy.yaml中的image占位符"
        run: sed -i 's/__IMAGE__/${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tags }}' deploy.yaml
        
      - name: "部署到k8s集群"
        uses: Azure/k8s-deploy@v4.7
        with:
          # Choose the target Kubernetes namespace. If the namespace is not provided, the commands will run in the default namespace.
          namespace: baozaolaoba
          # Path to the manifest files which will be used for deployment.
          manifests: deploy.yaml
          # Fully qualified resource URL of the image(s) to be used for substitutions on the manifest files Example: contosodemo.azurecr.io/helloworld:test
          images: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tags }}'
          # Name of a docker-registry secret that has already been set up within the cluster. Each of these secret names are added under imagePullSecrets field for the workloads found in the input manifest files
          imagepullsecrets: docker-login
          # deploy, promote, or reject
          action: deploy
      
